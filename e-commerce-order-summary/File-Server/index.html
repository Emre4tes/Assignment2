<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Summary Alternative</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    a {
      font-size: 40px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 20px;
      margin-left: 50px;
    }
    pre,
    p,
    h3,
    span,
    strong {
      color: #007bff;
      margin-bottom: 20px;
    }
    pre,
    p {
      font-size: 20px;
      font-weight: bold;
    }
    h3,
    strong,
    span {
      font-size: 25px;
      font-weight: bold;
    }
    .nav-tabs {
      margin-bottom: 20px;
      background-color: #007bff;
      width: 100%;
    }
    .nav-tabs .nav-link {
      color: #007bff;
      font-size: 30px;
      font-weight: bold;
      border-radius: 0px;
      background-color: #f8f9fa;
      border-color: #dee2e6;
    }
    .nav-tabs .nav-link.active {
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
    }
    .tab-content .tab-pane {
      padding: 20px;
      border: 1px solid #dee2e6;
      border-top: none;
      background-color: #f8f9fa;
    }
  </style>
</head>

<body>
  <div class="container">
    <a class="navbar-brand" href="http://localhost:4200">E-Commerce App</a>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button"
          role="tab" aria-controls="order" aria-selected="true">Order</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button"
          role="tab" aria-controls="shipping" aria-selected="false">Shipping</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tax-tab" data-bs-toggle="tab" data-bs-target="#tax" type="button" role="tab"
          aria-controls="tax" aria-selected="false">Tax</button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="myTabContent">
      <div class="tab-pane fade show active" id="order" role="tabpanel" aria-labelledby="order-tab">
        <h3>Order Details:</h3>
        <div id="items-list"></div>
        <div class="order-summary-section">
          <h3>Order Details Total:</h3>
          <span id="items-total"></span>
        </div>
        <div class="order-summary-section">
          <h3>Order Total:</h3>
          <span id="order-total"></span>
        </div>
        <div class="order-summary-section">
          <h3>Tax Amount:</h3>
          <span id="tax-info"></span>
        </div>
      </div>
      <div class="tab-pane fade" id="shipping" role="tabpanel" aria-labelledby="shipping-tab">
        <h3>Shipping:</h3>
        <pre id="shipping-info"></pre>
      </div>
      <div class="tab-pane fade" id="tax" role="tabpanel" aria-labelledby="tax-tab">
        <h3>Tax:</h3>
        <span id="tax-summary"></span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const apiUrl = 'http://localhost:3000';
    const uniqueIdentifier = '3b5c6d1e-8a6a-44c8-9baf-7a2b4c1e9c59';

    // API İsteklerini yeniden denemek için yardımcı fonksiyon
    async function fetchWithRetry(url, options = {}, attempts = 5, delayMs = 100) {
      for (let i = 0; i < attempts; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
          return response.json(); // JSON yanıtını döndürür
        } catch (error) {
          if (i === attempts - 1) throw error; // Son denemede hata fırlat
          await new Promise(resolve => setTimeout(resolve, delayMs)); // Gecikme süresi
        }
      }
    }
    // API isteği oluşturmak için genel fonksiyonunda gerekli ksısımalra burdana ulaşıyorum
    function createApiRequest(endpoint, params = '') {
      const url = `${apiUrl}/${endpoint}${params}`;
      const options = {headers: { 'Authorization': `Bearer ${uniqueIdentifier}` }};
      return fetchWithRetry(url, options);
    }
    // Sipariş detaylarını almak için API isteği oluşturdum
    async function retrieveOrderDetails() {
      try {
        const orderData = await createApiRequest('order');//API istegi oluşturmamızı saglıyoruz
        return orderData;
      } catch (error) {
        console.error('Error retrieving order details:', error);
        throw error;
      }
    }
    // Vergi detaylarını almak için API isteği oluşturdm
    async function retrieveTaxDetails() {
      try {
        const taxData = await createApiRequest('tax');
        return taxData;
      } catch (error) {
        console.error('Error retrieving tax details:', error);
        throw error;
      }
    }
    // Gönderim detaylarını almak için API isteği oluşturdum
    async function retrieveShippingDetails(weight) {
      try {
        const shippingData = await createApiRequest('shipping', `?weight=${weight}`);
        return shippingData;
      } catch (error) {
        console.error('Error retrieving shipping details:', error);
        throw error;
      }
    }
    // Sipariş öğelerini HTML formatında döndürme
    function displayItems(items) {
      return items.map(item => `
        <div>${item.name} - $${item.price.toFixed(2)} x ${item.qty}</div>
      `).join('');
    }
    // Öğelerin toplam miktarını formatlama
    function displayItemsTotal(amount) {
      return `Items Total: $${amount.toFixed(2)}`;
    }
    // Gönderim bilgilerini formatlama
    function displayShippingInfo(shipping) {
      return `
        <strong>Carrier:</strong> ${shipping.carrier}<br>
        <strong>Address:</strong> ${shipping.address}<br>
        <strong>Cost:</strong> $${shipping.cost.toFixed(2)}
      `;
    }
    // Vergi detaylarını formatlama
    function displayTaxDetails(tax) {
      return `Tax Rate: ${(tax.rate * 100).toFixed(2)}%`;
    }
    // Toplam miktarı hesaplama
    function displayGrandTotal(itemsTotal, shippingCost, taxAmount) {
      const grandTotal = itemsTotal + shippingCost + taxAmount;
      return `Total: $${grandTotal.toFixed(2)}`;
    }
    // Sipariş özetini almak ve sayfada göstermek için ana işlev
    async function loadOrderSummary() {
      try {
        const [orderData, taxData] = await Promise.all([//bir dizi promise alır ve bu promise'lerin hepsi tamamlandığında (resolve edildiğinde) tek bir promise döner.
          fetchData('order'),
          fetchData('tax')
        ]);//Sipariş ve vergi detaylarının al
        const totalWeight = orderData.items.reduce((total, item) => total + item.weight * item.qty, 0); // Toplam ağırlığı hesaplanıyor
        const shippingData = await fetchData('shipping', `?weight=${totalWeight}`);// Gönderim detaylarını al

        const itemsTotal = orderData.items.reduce((total, item) => total + item.price * item.qty, 0); // Öğeler toplamını hesaplanıyor
        const taxAmount = itemsTotal * taxData.rate; // Vergi miktarını hesaplanıyor
        const shippingCost = shippingData.cost; // Gönderim maliyetini al
        // Verileri sayfada göster
        document.getElementById('items-list').innerHTML = displayItems(orderData.items);
        document.getElementById('items-total').innerText = displayItemsTotal(itemsTotal);
        document.getElementById('shipping-info').innerHTML = displayShippingInfo(shippingData);
        document.getElementById('tax-summary').innerText = displayTaxDetails(taxData);
        document.getElementById('order-total').innerText = displayGrandTotal(itemsTotal, shippingCost, taxAmount);
      } catch (error) {
        console.error('Error loading order summary:', error); // Hata durumunda logla
        document.getElementById('order-summary-alternative').innerText = 'Failed to load order summary'; // Hata mesajı
      }
    }
    loadOrderSummary(); // Sayfa yüklendiğinde sipariş özetini yükle
  </script>
</body>

</html>
